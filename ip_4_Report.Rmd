---
title: "Independent Project Report"
author: "Wynne Moss"
date: "October 31, 2018"
output: md_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, include = FALSE}
library(rstanarm)
library(ggplot2)
library(lme4)
library(rstan)
```

## The data
SUMMARY OF DATASET: I quantified parasite communities across 10 different pond sites in the East Bay of California; each site was visited 4-6 times within the 2017 summer. At each visit I collected 10-12 individuals from 2 amphibian species. Individuals were measured and parasite infection was quantified.

GROUPING VARIABLES: 
  * Site (10 ponds) - this is a random variable.
  * Population (2 species at each site) - this is a random variable

PREDICTOR VARIABLES:

  * Species (2 species) - I think this is a better designation for species
  
  * Body size (snout-vent-length) - A continuous variable (fixed effect) at the individual level
  
  * Developmental stage - A continuous variable at the individual level...problematic since development is measured differently in newts vs. frogs
  
  * Sex - A factor variable at the individual level

  * Visit - A continuous variable (though could be treated as a factor if the relationship si non linear)

RESPONSE VARIABLE:

  * The number of parasites found within an individual. For this analysis, just count number of Echinostoma parasites. Can be modeled as Poisson distributed with a negative binomial to account for aggregation. Infection status (1 or 0) could also be modeled as a binary response variable using logistic regression. 

![Experimental Design](ip_fig_design.png)

## Questions
1) Does the impact of species and body size change over the course of the summer (interact with visit)?
2) How much of the variation in overall parasite load is explained by visit-level, species-level, site-level, or individual-level variation?

## Display the structure of the data
```{r}
dis <- read.csv("diss.data.2017.csv")
# colnames(dis)
str(dis)
dis$Pop <- paste(dis$SiteCode, dis$SpeciesCode, sep = "_") 
# each population is sampled multiple time so the observations are nested with in pop

```

## Model formulation
For now, I'll focus on question 1 with the response variable being `Echinostoma` (number of Echinostoma parasites found within that individual)


At the individual level, parasite load ($y_i$) is Poisson distributed with an expected mean of $\mu_i$

  (Equation 1) $y_i$ ~ Poisson($\mu_{i}$) 

The log(expected mean parasite level) is predicted by visit, species, snout vent length, and interaction, with each individual deviating from expected by $\epsilon_i$.

  (Equation 2) $log(\mu_i)$ = $\alpha_{j[i]}$ + $\beta_1*visit$ + $\beta_2*species$ + $\beta_3*SVL$ + $\beta_4*visit*species$ + $\beta_5*visit*SVL$ + $\epsilon_i$

Those deviations follow a normal distribution centered around 0 with variance of $\sigma^2_\epsilon$. This is the overdispersion parameter.

  (Equation 3) $\epsilon_i$ ~ Normal(0, $\sigma^2_\epsilon$)

Each individual is a member of a repeatedly sampled population. The populations are centered around the mean for that site ($\gamma_{k[i]}$).:

  (Equation 4) $\alpha_j$ ~ Normal($\gamma_{k[i]}$, $\sigma^2_\alpha$)

The mean for a particular site is drawn from a distribution centered at the mean among sites ($\bar{\gamma}$):

  (Equation 5) $\gamma_k$ ~ Normal($\bar{\gamma}$, $\sigma^2_\gamma$)

If there were site level covariates (in the future), $\bar{\gamma}$ could be predicted with another linear model with site-level covariates (e.g. snail density, size, location).

## Stan formulation
In stan_glm, the model could be written as:
```{r, eval = FALSE}
stan.fit <- stan_glmer(Echinostoma ~ visit*SpeciesCode + visit*SVL + (1|SiteCode) + (1|Pop) +
                         (1|HostCode), data = dis,  family =poisson(link="log"))
summary(stan.fit)
# launch_shinystan(stan.fit)
stan.samp <- sample(stan.fit)
save(stan.samp, file = "stan.fit.1.RData")
```

The interactions aren't significant (overlap with zero) so I will remove and re-fit. I'm also going to add a random slope model because I think the effect of species depends on site. The two species are very similar at some sites and very different at other sites.

```{r, eval = FALSE}
stan.fit2 <- stan_glmer(Echinostoma ~ visit + SpeciesCode + SVL + (SpeciesCode|SiteCode) + (1|Pop) +
                         (1|HostCode), data = dis,  family =poisson(link="log"))
```


## Exploring model fit
```{r}

```


Next steps: Perhaps use a random slope model as well (visit|SiteCode). Developmental stages could perhaps be included with an interaction with species, which would allow TATO to have some levels and PSRE to have other levels. e.g. I need to put them in the same column. Will autocorrelation of fixed and random effects (e.g. Species, Population) become an issue?


